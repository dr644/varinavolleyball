{% extends 'main/base.html' %}
{% block content %}
<div class="social-feed w-full mx-auto mt-6 px-4">
  <!-- Header -->
  <div class="flex flex-wrap justify-between items-center mb-6 max-w-6xl mx-auto gap-3">
    <h1 class="text-2xl font-bold text-navy">Varina Volleyball Community</h1>

    <div class="flex items-center gap-2">
      <!-- Sort Dropdown -->
      <form method="get" id="sortForm" class="flex items-center">
        <label for="sort" class="mr-2 text-sm text-gray-700 whitespace-nowrap">Sort:</label>

        <div class="relative inline-block">
          <select
            name="sort"
            id="sort"
            class="appearance-none form-control text-sm py-1 pl-3 pr-8 rounded-md border border-gray-300 text-gray-700 cursor-pointer hover:border-navy focus:border-navy focus:ring-0 transition"
            onchange="document.getElementById('sortForm').submit()"
            style="min-width: 110px;">
            <option value="new" {% if request.GET.sort == 'new' or not request.GET.sort %}selected{% endif %}>New</option>
            <option value="best" {% if request.GET.sort == 'best' %}selected{% endif %}>Best</option>
          </select>

          <!-- proper dropdown arrow inside select box -->
          <i class="fa-solid fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs pointer-events-none"></i>
        </div>
      </form>


      <!-- New Post Button -->
      <a href="{% url 'create_post' %}" class="btn-gold btn-create-post ml-2 whitespace-nowrap">
        + New Post
      </a>
    </div>
  </div>


  <!-- ✅ POSTS GRID -->
  <div id="post-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
    {% include 'social/_posts.html' with posts=posts %}
  </div>

  <!-- ✅ Loader -->
  <div id="loader" class="text-center mt-8 hidden">
    <p class="text-gray-500">Loading more posts...</p>
  </div>
</div>

<!-- ✅ Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
  <img id="modalImage" src="" alt="Expanded Image" class="max-w-[90%] max-h-[90%] rounded-xl shadow-lg">
</div>

<script>
let page = 1;
let loading = false;
let endReached = false;

// Infinite Scroll
window.addEventListener('scroll', () => {
  if (loading || endReached) return;
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 200) {
    loadMorePosts();
  }
});

function loadMorePosts() {
  loading = true;
  const loader = document.getElementById('loader');
  loader.classList.remove('hidden');

  const sort = new URLSearchParams(window.location.search).get('sort') || 'new';
  fetch(`?page=${++page}&sort=${sort}`, { headers: { 'x-requested-with': 'XMLHttpRequest' } })
    .then(res => res.json())
    .then(data => {
      if (!data.html.trim()) {
        endReached = true;
        loader.innerHTML = "<p class='text-gray-400'>No more posts.</p>";
        return;
      }

      document.getElementById('post-grid').insertAdjacentHTML('beforeend', data.html);

      // ✅ Stop fetching when no more pages
      if (!data.has_next) {
        endReached = true;
        loader.innerHTML = "<p class='text-gray-400'>No more posts.</p>";
      }
    })
    .catch(err => console.error('Error loading posts:', err))
    .finally(() => {
      loader.classList.add('hidden');
      loading = false;
    });
}

// Image modal
function openImageModal(src) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  modalImage.src = src;
  modal.classList.remove('hidden');
  modal.classList.add('flex');
}

document.getElementById('imageModal').addEventListener('click', () => {
  const modal = document.getElementById('imageModal');
  modal.classList.remove('flex');
  modal.classList.add('hidden');
});
</script>

{% endblock %}
